<uni-toolbar
    [config]="toolbarconfig"
    [saveactions]="saveactions"
    [subheads]="toolbarSubheads"
    [commentsConfig]="commentsConfig"
    [selectConfig]="selectConfig"
    [validationMessages]="toolbarStatusValidation"
    (selectValueChanged)="numberSeriesChange($event)">
</uni-toolbar>

<section class="customer-details application">
    <uni-tabs [tabs]="tabs" [(activeIndex)]="activeTabIndex" (tabClick)="showTab()"></uni-tabs>

    <!-- Details tab -->
    <ng-template [ngIf]="activeTabIndex === 0">
        <uni-form
            [config]="{autofocus: true}"
            [fields]="fields$"
            [model]="customer$"
            (changeEvent)="onChange($event)"
            (errorEvent)="onError($event)">
        </uni-form>

        <ng-template [ngIf]="(customer$ | async)?.ID">
            <article *ifFeaturePermission="'ui.sellers'" class="collapsable" [ngClass]="{'-is-open': showSellerSection}">
                <h4 (click)="showSellerSection = !showSellerSection">Selgere</h4>
                <div class="collapsable-content">
                    <seller-links style="width: 100%;"
                        [entity]="(customer$ | async)"
                        (entityChange)="onSellersChange($event)">
                    </seller-links>
                </div>
            </article>

            <article class="collapsable" [ngClass]="{'-is-open': showContactSection}">
                <h4 (click)="showContactSection = !showContactSection">Kontakter</h4>
                <div class="collapsable-content">
                    <contacts
                        [parentBusinessRelation]="(customer$ | async)?.Info"
                        (parentBusinessRelationChange)="onContactsChange()">
                    </contacts>
                </div>
            </article>
        </ng-template>

        <article *ifFeaturePermission="'ui.debt-collection'" class="collapsable" [ngClass]="{'-is-open': showReminderSection}">
            <h4 (click)="showReminderSection = !showReminderSection">Purring</h4>
            <div class="collapsable-content">
                <reminder-settings
                    [reminderSettings]="(customer$ | async)?.CustomerInvoiceReminderSettings"
                    (reminderSettingsChange)="onChange($event)">
                </reminder-settings>
            </div>
        </article>
    </ng-template>

    <!-- Distribution tab -->
    <section *ngIf="activeTabIndex === 1" class="uni-container">
        <header>Utsendelse</header>

        <section>
            <section class="distribution-type-container customer-view" *ngFor="let type of entityTypes">
                <div class="content-container customer-view">
                    <section class="entity-name-container">
                        <span> {{ type.label }} </span>
                    </section>

                    <section class="entity-priority-container">
                        <span>{{
                            type.defaultPlan
                                ? 'Standardplan: ' + type.defaultPlan.Name
                                : companySettings && companySettings.Distributions && companySettings.Distributions[type.keyValue]
                                    ? 'Standardplan for firma'
                                    : 'Ingen plan satt'
                        }}</span>

                        <ul class="distribution-elements-stepper" *ngIf="type.defaultPlan">
                            <ng-container *ngFor="let elem of type.defaultPlan.Elements; let i = index;">
                                <li class="list-item"> {{ elem.Priority }}. {{ elem.ElementType.Name }} </li>
                                <li class="divider" *ngIf="i < type.defaultPlan.Elements.length - 1"></li>
                            </ng-container>
                            <li class="list-item" *ngIf="!type.defaultPlan.Elements.length"> Ingen automatisk utsendelse </li>
                        </ul>
                    </section>

                    <section class="entity-functionality-container">
                        <button class="tertiary c2a" (click)="changeDistributionPlan(type)">
                            Endre plan
                        </button>

                        <button class="icon-button remove-distribution"
                            (click)="removeDistributionPlan(type)"
                            [ngClass]="!type.defaultPlan ? 'disabled' : ''"
                            [disabled]="!type.defaultPlan"
                            [title]="!type.defaultPlan ? 'Ingen plan Ã¥ fjerne' : 'Fjerne plan fra kunde'">
                            <i class="material-icons">delete_outline</i>
                        </button>
                    </section>
                </div>
            </section>
        </section>
    </section>

    <!-- Reconciliation tab -->
    <section *ngIf="activeTabIndex === 2" class="uni-container customer-post-post-view">
        <div style="display: flex;">
            <uni-tabs
                [tabs]="postposttabs"
                (tabClick)="onPostpostFilterClick($event)">
            </uni-tabs>
            <button class="good" (click)="goToPostpost()">Rediger</button>
        </div>

        <ledger-account-reconciliation style="font-size: .9rem"
            [customerBankAccounts]="(customer$ | async)?.Info?.BankAccounts"
            [disablePaymentToField]="true"
            [accountNumber]="(customer$ | async)?.CustomerNumber"
            [showRowSelect]="false"
            [hideHeader]="true"
            [customerID]="(customer$ | async)?.ID">
        </ledger-account-reconciliation>
    </section>

    <!-- Products sold tab -->
    <customer-products-sold *ngIf="activeTabIndex === 3"
        [customerID]="(customer$ | async)?.ID">
    </customer-products-sold>

    <!-- Attachments tab -->
    <section *ngIf="activeTabIndex === 4" class="uni-container">
        <uni-attachments
            id="attachments"
            [entity]="'Customer'"
            [entityID]="(customer$ | async)?.ID">
        </uni-attachments>
    </section>

    <!-- Company tab -->
    <subcompanycomponent
        *ngIf="activeTabIndex === 5"
        [customer]="customer$ | async"
        (customerChange)="onSubCompanyChange($event)">
    </subcompanycomponent>

    <!-- TOF tabs  -->
    <section *ngIf="showReportWithID" class="uni-container">
        <uni-query-read-only
            [queryDefinitionID]="showReportWithID"
            [customerID]="(customer$ | async)?.ID"
            [filterValue]="(customer$ | async)?.ID">
        </uni-query-read-only>
    </section>

</section>
