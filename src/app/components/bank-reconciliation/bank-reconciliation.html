<section class="application view-wrapper uni-redesign">
    <section class="reconciliation-toolbar">
        <section class="left-side">
            <h1>Bankavstemming</h1>
            <section class="select-wrapper">
                <label>
                    <span>Konto</span>
                    <select [(ngModel)]="selectedBankAccount" (change)="onBankPeriodChange()">
                        <option *ngFor="let bankAccount of bankAccounts" [ngValue]="bankAccount">
                            {{bankAccount.Account?.AccountNumber}} - {{bankAccount.Account?.AccountName}}
                            ({{(bankAccount.AccountNumber | uniaccountnumber) || bankAccount.IBAN}})
                        </option>
                    </select>
                </label>

                <label>
                    <span>Periode</span>
                    <month-picker
                        [(value)]="bankPeriod"
                        (valueChange)="onBankPeriodChange()">
                    </month-picker>
                </label>
            </section>
        </section>

        <section class="pull-right">
            <button [disabled]="!loaded" class="outline-c2a tight" (click)="startAutoMatch()">
                <i class="material-icons">sync_alt</i>
                Automatisk kobling
            </button>

            <button [disabled]="!loaded" class="outline-c2a tight" (click)="openJournalModal()">
                <i class="material-icons">edit</i>
                Bilagsføring
            </button>

            <button [disabled]="!loaded" class="outline-c2a tight" (click)="openImportModal()">
                <i class="material-icons">cloud_upload</i>
                Importer
            </button>

            <button class="good" (click)="save()" [disabled]="!session.closedGroups?.length">
                Lagre
            </button>
        </section>
    </section>

    <section class="reconciliation-view">
        <section class="list-section">
            <section class="list-header" [attr.aria-busy]="session.busy">
                <section class="overflow-ellipsis">
                    <span>
                        {{selectedBankAccount?.AccountNumber}}
                        {{(selectedBankAccount?.Bank?.Name || selectedBankAccount?.Account?.AccountName)}}
                    </span>
                </section>

                <small>Saldo</small>
                <span class="nowrap" [ngClass]="session.bankBalance >= 0 ? 'positive' : 'negative'">{{session.bankBalance | uninumberformat: 'money'}}</span>
            </section>

            <bank-statement-entries *ngIf="!cleanUp"
                [items]="session.bankEntries"
                (itemSelected)="session.checkOrUncheck($event)">
            </bank-statement-entries>
        </section>

        <section class="reconciliation-summary" [attr.aria-busy]="session.preparing" >
            <section class="header">
                <mat-slide-toggle (change)="checkSuggest(true)" [(ngModel)]="autoSuggest" class="max-width" [labelPosition]="'before'">
                    Foreslå koblinger
                </mat-slide-toggle>
            </section>

            <section class="content">
                <section class="warning-label" *ngIf="session.totalImbalance">
                    <span>
                        <i class="material-icons">error</i>
                        Avvik i saldo:
                    </span>
                    <span [ngClass]="session.totalImbalance >= 0 ? 'positive' : 'negative'">
                        {{session.totalImbalance | uninumberformat: 'money'}}
                    </span>
                </section>

                <section *ngIf="!session.stage?.length" class="no-match-drafts">
                    Koble poster ved å klikke på transaksjonene
                </section>

                <ul *ngIf="session.stage?.length" class="match-drafts">
                    <ng-container *ngFor="let entry of session.stage">
                        <li>
                        <span>{{entry.Date | date: 'dd.MM'}} - {{(entry.IsBankEntry ? 'Bank' : 'Regnskap')}}</span>
                        <span [ngClass]="entry.Amount >= 0 ? 'positive' : 'negative'">
                            {{entry.Amount | uninumberformat: 'money' || 0}}
                        </span>
                        </li>
                    </ng-container>

                    <li *ngIf="session.stageTotal" class="diff">
                        <span>Differanse</span>
                        <span [ngClass]="{'has-diff': !!session.stageTotal}">
                            {{session.stageTotal | uninumberformat: 'money' || 0}}
                        </span>
                    </li>
                </ul>

                <button (click)="closeStage()" class="c2a" [disabled]="!session.canCloseStage">
                    <i class="material-icons">link</i>
                    Koble sammen
                </button>


                <section *ngIf="session.closedGroups?.length > 0" class="closed-groups-summary">
                    <span class="bullet">{{session.closedGroups.length}}</span>
                    <p>Koblinger klar for lagring</p>
                    <button (click)="reset()" class="reset-button tertiary">
                        <i class="material-icons">settings_backup_restore</i>
                        Nullstill
                    </button>
                </section>
            </section>
        </section>

        <section class="list-section">
            <section class="list-header" [attr.aria-busy]="session.busy">
                <span>Regnskap - {{selectedBankAccount?.Account?.AccountNumber}}</span>
                <small>Saldo</small>
                <span class="nowrap" [ngClass]="session.journalEntryBalance >= 0 ? 'positive' : 'negative'">{{session.journalEntryBalance | uninumberformat: 'money'}}</span>
            </section>

            <bank-statement-entries *ngIf="!cleanUp"
                [items]="session.journalEntries"
                (itemSelected)="session.checkOrUncheck($event)">
            </bank-statement-entries>
        </section>
    </section>
</section>