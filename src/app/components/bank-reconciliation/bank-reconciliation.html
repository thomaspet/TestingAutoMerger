<section class="application view-wrapper uni-redesign">
    <section class="reconciliation-toolbar">
        <section class="left-side">
            <h1>Bankavstemming</h1>
            <section class="select-wrapper">
                <label>
                    <span>Konto</span>
                    <select [(ngModel)]="selectedBankAccount" (change)="onBankPeriodChange()">
                        <option *ngFor="let bankAccount of bankAccounts" [ngValue]="bankAccount">
                            {{bankAccount.Account?.AccountNumber}} - {{bankAccount.Account?.AccountName}}
                            ({{(bankAccount.AccountNumber | uniaccountnumber) || bankAccount.IBAN}})
                        </option>
                    </select>
                </label>

                <section class="period-picker">
                    <button class="icon-button" (click)="onBankPeriodChange(-1)">
                        <i class="material-icons">arrow_left</i>
                    </button>

                    <month-picker
                        [(value)]="bankPeriod"
                        (valueChange)="onBankPeriodChange()">
                    </month-picker>

                    <button class="icon-button" (click)="onBankPeriodChange(1)">
                        <i class="material-icons">arrow_right</i>
                    </button>
                </section>
            </section>
        </section>

        <section class="pull-right">
            <button [disabled]="!loaded" class="outline-c2a tight" (click)="startAutoMatch()">
                <i class="material-icons">compare_arrows</i>
                Automatisk kobling
            </button>

            <button [disabled]="!loaded" class="outline-c2a tight" (click)="openJournalModal()">
                <i class="material-icons">edit</i>
                Bilagsføring
            </button>

            <button [disabled]="!loaded" class="outline-c2a tight" (click)="openImportModal()">
                <i class="material-icons">cloud_upload</i>
                Importer
            </button>

            <!-- <button class="good" (click)="save()" [disabled]="!session.closedGroups?.length">
                Lagre
            </button> -->
        </section>
    </section>

    <section class="reconciliation-view">
        <section class="list-section">
            <section class="list-header" [attr.aria-busy]="session.busy">
                <section class="overflow-ellipsis">
                    <span>
                        {{selectedBankAccount?.AccountNumber}}
                        {{(selectedBankAccount?.Bank?.Name || selectedBankAccount?.Account?.AccountName)}}
                    </span>
                </section>

                <small>Saldo</small>
                <span class="nowrap" [ngClass]="session.bankBalance >= 0 ? 'positive' : 'negative'">{{session.bankBalance | uninumberformat: 'money'}}</span>
            </section>

            <bank-statement-entries *ngIf="!cleanUp"
                [items]="session.bankEntries"
                [stageInfo]="session.stageInfo.bank"
                (itemSelected)="session.checkOrUncheck($event)"
                (showClosedGroups)="closedGroupDetailsVisible = true">
            </bank-statement-entries>
        </section>

        <section class="center-section">
            <section class="warning-label" *ngIf="session.totalImbalance">
                <span>
                    <i class="material-icons warn">error</i>
                    Avvik i saldo:
                </span>
                <span [ngClass]="session.totalImbalance >= 0 ? 'positive' : 'negative'">
                    {{session.totalImbalance | uninumberformat: 'money'}}
                </span>
            </section>

            <section class="reconciliation-summary" [attr.aria-busy]="session.preparing" >
                <section class="header">
                    <mat-slide-toggle *ngIf="session.status == 3" (change)="checkSuggest(true)" [(ngModel)]="autoSuggest" class="max-width" [labelPosition]="'before'">
                        Foreslå koblinger
                    </mat-slide-toggle>
                    <span *ngIf="session.status != 3">
                        Avstemming
                    </span>
                </section>

                <section class="content">
                    <section *ngIf="session.status == 2" class="info-box">
                        <article>Du har ingen bankposter.</article>
                        <article>Velg "Importer" for å lese inn en bankfil manuelt.</article>
                        <i style="font-size: 20pt" class="material-icons">cloud_upload</i>
                    </section>

                    <section *ngIf="session.status == 3 && !session.stage?.length" class="no-match-drafts c2a">
                        Koble poster ved å klikke på transaksjonene
                    </section>

                    <section *ngIf="session.status == 4" class="warn" style="text-align: left;">
                        Du har bankposter som ikke finnes i regnskapet.
                        <br> Du kan bruke "Bilagsføring" oppe til høyre for å bokføre disse.
                    </section>

                    <section *ngIf="session.status == 5" class="info-box warn">
                        Du har poster i regnskapet som ikke finnes på bankutskriften.
                    </section>

                    <section *ngIf="session.status == 6" class="info-box c2a">
                        Du er nesten ferdig!
                        <article>Klikk på 'Lagre' for å fullføre merkingen!</article>
                    </section>

                    <section *ngIf="session.status == 7" class="info-box good">
                        <i style="font-size: 40pt" class="material-icons">done</i>
                        <article>Alle poster er avstemt for perioden</article>
                    </section>

                    <ul *ngIf="session.stage?.length" class="match-drafts">
                        <ng-container *ngFor="let entry of session.stage">
                            <li>
                            <span>{{entry.Date | date: 'dd.MM'}} - {{(entry.IsBankEntry ? 'Bank' : 'Regnskap')}}</span>
                            <span [ngClass]="entry.Amount >= 0 ? 'positive' : 'negative'">
                                {{entry.Amount | uninumberformat: 'money' || 0}}
                            </span>
                            </li>
                        </ng-container>

                        <li *ngIf="session.stageTotal" class="diff">
                            <span>Differanse</span>
                            <span [ngClass]="{'has-diff': !!session.stageTotal}">
                                {{session.stageTotal | uninumberformat: 'money' || 0}}
                            </span>
                        </li>
                    </ul>

                    <button (click)="closeStage()" *ngIf="session.canCloseStage || session.status == 3" class="c2a" [disabled]="!session.canCloseStage">
                        <i class="material-icons">link</i>
                        Koble sammen
                    </button>
                </section>

                <section class="footer" *ngIf="session.closedGroups?.length > 0">
                    <a (click)="closedGroupDetailsVisible = true">
                        {{session.closedGroups?.length}}
                        {{session.closedGroups?.length === 1 ? 'kobling' : 'koblinger'}}
                            klar for lagring
                    </a>

                    <section class="save-actions">
                        <button (click)="save()" [ngClass]="{'good': session.status == 6}">
                            <i class="material-icons">check</i>
                            Lagre
                        </button>

                        <button (click)="reset()" class="reset-button tertiary">
                            <i class="material-icons">settings_backup_restore</i>
                            Nullstill
                        </button>
                    </section>
                </section>
            </section>
        </section>

        <section class="list-section">
            <section class="list-header" [attr.aria-busy]="session.busy">
                <span>Regnskap - {{selectedBankAccount?.Account?.AccountNumber}}</span>
                <small>Saldo</small>
                <span class="nowrap" [ngClass]="session.journalEntryBalance >= 0 ? 'positive' : 'negative'">{{session.journalEntryBalance | uninumberformat: 'money'}}</span>
            </section>

            <bank-statement-entries *ngIf="!cleanUp"
                [items]="session.journalEntries"
                [stageInfo]="session.stageInfo.journal"
                (itemSelected)="session.checkOrUncheck($event)"
                (showClosedGroups)="closedGroupDetailsVisible = true">
            </bank-statement-entries>
        </section>
    </section>
</section>

<closed-reconciliations
    class="ontop"
    *ngIf="closedGroupDetailsVisible"
    (close)="closedGroupDetailsVisible = false">
</closed-reconciliations>