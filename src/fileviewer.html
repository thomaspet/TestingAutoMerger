<!doctype html>
<html lang="en">
<head>
    <title>Filvisning</title>
    <link rel="icon" type="image/x-icon" href="favicon.png?v=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet"href="https://fonts.googleapis.com/css?family=Roboto:400,500,700">
    <link rel="stylesheet" href="./assets/ehf-viewer.css">
    <script src="./assets/pdfjs/pdf.js"></script>

    <style>
        body {
            background: #d9d9d9;
            margin: 0;
        }

        header {
            position: fixed;
            top: 0;
            display: flex;
            width: 100vw;
            height: 3rem;
            padding: 0 38px 0 25px;
            box-sizing: border-box;
            background: #d9d9d9;
            color: #0f4880;
            user-select: none;
        }

        header img {
            height: 28px;
            margin: auto auto auto 0;
        }

        header span {
            font: 600 15px Arial;
            margin: auto 10px
        }

        header i.material-icons {
            margin: auto 0;
            cursor: pointer;
            margin-left: 8px;
            font-size: 26px;
        }

        main {
            box-sizing: border-box;
            padding: 3.5rem 25px 10px;
        }

        #container {
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 1200px;
        }

        #container .file {
            display: block;
            margin: 0 auto 16px;
            max-width: 100%;
            box-shadow: 0px 1px 4px 0 rgba(0, 0, 0, 0.14);
        }
    </style>
</head>
<body>
    <header class="zoom-control">
        <span id="zoom-level-info"></span>
        <i id="zoom-in" class="material-icons">add_circle</i>
        <i id="zoom-out" class="material-icons">remove_circle</i>
    </header>

    <main>
        <section id="container"></section>
    </main>
</body>

<script type="application/javascript">
    window.moveTo(0, 8);
    let zoomLevel = 100;

    const zoomLevelInfo = document.getElementById('zoom-level-info');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const container = document.getElementById('container');

    const updateImageZoom = () => {
        if (zoomLevelInfo) {
            zoomLevelInfo.innerText = zoomLevel + '%';
        }

        const images = container.querySelectorAll('.file');
        images.forEach(img => {
            img.style.maxWidth = zoomLevel + '%';
        });

        localStorage.setItem('fileviewer-zoom', zoomLevel);
    }

    const zoomIn = () => {
        if (container && zoomLevel < 100) {
            zoomLevel += 10;
            updateImageZoom();
        }

        window.innerHeight = 500;
    }

    const zoomOut = () => {
        if (container && zoomLevel > 10) {
            zoomLevel -= 10;
            updateImageZoom();
        }
    }

    zoomInBtn.onclick = () => zoomIn();
    zoomOutBtn.onclick = () => zoomOut();

    window.addEventListener('keydown', (event) => {
        const key = event.which || event.keyCode;
        if (key === 107) {
            zoomIn();
        } else if (key === 109) {
            zoomOut();
        }
    });

    const showPdf = (canvas, url) => {
        pdfjsLib.getDocument({url: url}).promise.then(
            function(pdf) {
                pdf.getPage(1).then(function(page) {
                    var scale = 1.5;
                    var viewport = page.getViewport({scale: scale});

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    });
                });
            },
            function (err) {
                console.error(err);
            }
        );
    }

    function loadData() {
        let container = document.getElementById('container');
        container.innerHTML = '';

        const files = JSON.parse(localStorage.getItem('fileviewer-data'));

        if (files && files.length) {
            files.forEach(file => {
                if (file._ehfMarkup) {
                    const ehfElement = document.createElement('section');
                    ehfElement.innerHTML = file._ehfMarkup;

                    ehfElement.classList.add('file');
                    ehfElement.style.maxWidth = zoomLevel + '%';
                    container.appendChild(ehfElement);

                    (file._ehfAttachments || []).forEach(attachment => {
                        if (attachment.resourceUrl && attachment.mimeType) {
                            let el;
                            if (attachment.mimeType.includes('image')) {
                                el = document.createElement('img');
                                el.src = attachment.resourceUrl;
                            } else {
                                el = document.createElement('canvas');
                                setTimeout(() => {
                                    showPdf(el, attachment.resourceUrl);
                                });
                            }

                            el.classList.add('file');
                            el.style.maxWidth = zoomLevel + '%';
                            container.appendChild(el);
                        }
                    });

                } else {
                    const imageUrls = file._imgUrls || [];
                    imageUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.classList.add('file');
                        img.style.maxWidth = zoomLevel + '%';

                        container.appendChild(img);
                    });
                }
            });
        }
    }

    window.onload = function() {
        var pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `//${window.location.host}/assets/pdfjs/pdf.worker.js`;

        const zoom = localStorage.getItem('fileviewer-zoom');
        if (zoom && parseInt(zoom)) {
            zoomLevel = parseInt(zoom);
        }

        zoomLevelInfo.innerText = zoomLevel + '%';
        this.loadData();
    }

    window.addEventListener('storage', (event) => {
        if (event.key === 'fileviewer-data' && event.newValue && event.oldValue !== event.newValue) {
            loadData();
        }
    });

</script>
</html>